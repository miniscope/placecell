<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>pcell browser</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      body {{ font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 1rem; }}
      #controls {{ margin-bottom: 0.75rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }}
      #status {{ margin-left: 0.5rem; font-size: 0.9rem; color: #444; }}
      #keep-container {{ margin-left: 0.75rem; display: flex; align-items: center; gap: 0.25rem; }}
      #kept-list {{ margin-top: 0.5rem; font-size: 0.85rem; color: #333; }}
      select {{ min-width: 120px; }}
      button {{ padding: 0.3rem 0.7rem; }}
    </style>
  </head>
  <body>
    <h1>pcell unit browser</h1>
    <p>Showing {n} units from {minian_path}</p>
    <div id="controls">
      <button id="prev-btn">&laquo; Prev</button>
      <button id="next-btn">Next &raquo;</button>
      <label>Unit:
        <select id="unit-select"></select>
      </label>
      <span id="status"></span>
      <span id="keep-container">
        <input type="checkbox" id="keep-checkbox" />
        <label for="keep-checkbox">keep</label>
      </span>
      <button id="download-btn">Download curated_units.txt</button>
    </div>
    <div id="kept-list"></div>
    <div id="plot" style="width: 100%; max-width: 1200px; height: 500px;"></div>
    <script>
      const unitIds = {unit_ids_json};
      const t = {t_json};
      const traces = {ys_json};

      const unitSelect = document.getElementById('unit-select');
      const statusEl = document.getElementById('status');
      const keepCheckbox = document.getElementById('keep-checkbox');
      const keptListEl = document.getElementById('kept-list');
      let idx = 0;
      const kept = new Set();

      // populate select
      unitIds.forEach((uid, i) => {{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = uid;
        unitSelect.appendChild(opt);
      }});

      function updateKeptList() {{
        if (kept.size === 0) {{
          keptListEl.textContent = 'Kept: (none yet)';
        }} else {{
          const arr = Array.from(kept.values()).sort((a, b) => a - b);
          keptListEl.textContent = 'Kept: ' + arr.join(', ');
        }}
      }}

      function render() {{
        const uid = unitIds[idx];
        const y = traces[idx];
        const data = [{{
          x: t,
          y: y,
          mode: 'lines',
          name: 'unit ' + uid
        }}];
        const layout = {{
          title: 'unit ' + uid,
          xaxis: {{ title: 'Time (s)' }},
          yaxis: {{ title: 'Fluorescence (a.u.)' }},
          margin: {{ l: 60, r: 20, t: 40, b: 50 }}
        }};
        Plotly.newPlot('plot', data, layout, {{responsive: true}});
        unitSelect.value = String(idx);
        statusEl.textContent = 'Unit ' + uid + ' (' + (idx + 1) + '/' + unitIds.length + ')';
        keepCheckbox.checked = kept.has(uid);
      }}

      document.getElementById('prev-btn').addEventListener('click', () => {{
        idx = (idx - 1 + unitIds.length) % unitIds.length;
        render();
      }});
      document.getElementById('next-btn').addEventListener('click', () => {{
        idx = (idx + 1) % unitIds.length;
        render();
      }});
      unitSelect.addEventListener('change', () => {{
        idx = parseInt(unitSelect.value, 10);
        render();
      }});

      keepCheckbox.addEventListener('change', () => {{
        const uid = unitIds[idx];
        if (keepCheckbox.checked) {{
          kept.add(uid);
        }} else {{
          kept.delete(uid);
        }}
        updateKeptList();
      }});

      document.getElementById('download-btn').addEventListener('click', () => {{
        const arr = Array.from(kept.values()).sort((a, b) => a - b);
        const text = arr.join('\\n') + (arr.length ? '\\n' : '');
        const blob = new Blob([text], {{type: 'text/plain'}});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'curated_units.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }});

      // initial render
      render();
      updateKeptList();
    </script>
  </body>
</html>

