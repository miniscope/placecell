<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>pcell place browser</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      body {{ font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 1rem; }}
      #controls {{ margin-bottom: 0.75rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }}
      #status {{ margin-left: 0.5rem; font-size: 0.9rem; color: #444; }}
      select {{ min-width: 120px; }}
      button {{ padding: 0.3rem 0.7rem; }}
    </style>
  </head>
  <body>
    <h1>pcell place browser</h1>
    <p>Trajectory with spike locations per unit (s ≥ {s_threshold}, speed threshold: {speed_threshold} {speed_units}).</p>
    <div id="controls">
      <button id="prev-btn">&laquo; Prev</button>
      <button id="next-btn">Next &raquo;</button>
      <label>Unit:
        <select id="unit-select"></select>
      </label>
      <span id="status"></span>
    </div>
    <div id="plot_trace" style="width: 100%; max-width: 1200px; height: 280px;"></div>
    <div id="plot_place" style="width: 100%; max-width: 1200px; height: 500px;"></div>
    <script>
      const unitIds = {unit_ids_json};
      const x_full = {x_full_json};
      const y_full = {y_full_json};
      const spikeXsAbove = {spike_xs_above_json};
      const spikeYsAbove = {spike_ys_above_json};
      const spikeXsBelow = {spike_xs_below_json};
      const spikeYsBelow = {spike_ys_below_json};
      const countsAbove = {counts_above_json};
      const countsBelow = {counts_below_json};
      const traceT = {trace_t_json};
      const traceYsRaw = {trace_ys_raw_json};
      const traceYsLp = {trace_ys_lp_json};
      const traceYsYrA = {trace_ys_yrA_json};
      const traceYsS = {trace_ys_S_json};
      const hasYrA = {has_yrA};
      const hasS = {has_S};
      const speedThreshold = {speed_threshold};
      const speedUnits = '{speed_units}';
      const spikeTsTraceAbove = {spike_ts_trace_above_json};
      const spikeYTraceAbove = {spike_y_trace_above_json};
      const spikeTsTraceBelow = {spike_ts_trace_below_json};
      const spikeYTraceBelow = {spike_y_trace_below_json};

      const hasTraces = traceT.length > 0 && traceYsRaw.length === unitIds.length;

      const unitSelect = document.getElementById('unit-select');
      const statusEl = document.getElementById('status');
      let idx = 0;

      // populate select
      unitIds.forEach((uid, i) => {{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = uid;
        unitSelect.appendChild(opt);
      }});

      function render() {{
        const uid = unitIds[idx];
        const xsAbove = spikeXsAbove[idx] || [];
        const ysAbove = spikeYsAbove[idx] || [];
        const xsBelow = spikeXsBelow[idx] || [];
        const ysBelow = spikeYsBelow[idx] || [];

        const traj = {{
          x: x_full,
          y: y_full,
          mode: 'lines',
          name: 'trajectory',
          line: {{ color: 'lightgray' }}
        }};

        const spikesAbove = {{
          x: xsAbove,
          y: ysAbove,
          mode: 'markers',
          name: 'spikes (speed ≥ ' + speedThreshold + ' ' + speedUnits + ')',
          marker: {{ size: 6, color: 'red', opacity: 0.9 }},
        }};

        const spikesBelow = {{
          x: xsBelow,
          y: ysBelow,
          mode: 'markers',
          name: 'spikes (speed < ' + speedThreshold + ' ' + speedUnits + ')',
          marker: {{ size: 6, color: 'orange', opacity: 0.7 }},
        }};

        const dataPlace = [
          traj,
          spikesAbove,
          {{
            x: xsBelow,
            y: ysBelow,
            mode: 'markers',
            name: 'spikes (speed < ' + speedThreshold + ' ' + speedUnits + ')',
            marker: {{ size: 6, color: 'orange', opacity: 0.7 }},
            visible: 'legendonly'
          }}
        ];
        const totalSpikes = countsAbove[idx] + countsBelow[idx];
        const layoutPlace = {{
          title: 'unit ' + uid + ' (above: ' + countsAbove[idx] + ', below: ' + countsBelow[idx] + ', total: ' + totalSpikes + ')',
          xaxis: {{ title: 'X' }},
          yaxis: {{ title: 'Y', scaleanchor: 'x', scaleratio: 1 }},
          margin: {{ l: 60, r: 20, t: 40, b: 50 }},
          showlegend: true,
        }};

        Plotly.newPlot('plot_place', dataPlace, layoutPlace, {{responsive: true}});

        if (hasTraces) {{
          const yRaw = traceYsRaw[idx];
          const yLp = traceYsLp[idx];
          const yYrA = hasYrA && traceYsYrA[idx] ? traceYsYrA[idx] : null;
          const yS = hasS && traceYsS[idx] ? traceYsS[idx] : null;
          const stsAbove = spikeTsTraceAbove[idx] || [];
          const syAbove = spikeYTraceAbove[idx] || [];
          const stsBelow = spikeTsTraceBelow[idx] || [];
          const syBelow = spikeYTraceBelow[idx] || [];

          // Find min/max of C trace for scaling S pulses
          const yMin = Math.min(...yRaw);
          const yMax = Math.max(...yRaw);
          const yRange = yMax - yMin;
          const sPulseHeight = yRange * 0.05;  // 5% of trace height
          const sPulseBase = yMin - sPulseHeight * 2;  // Position pulses below trace

          const dataTrace = [];
          
          // Add YrA if available (hidden by default)
          if (yYrA) {{
            dataTrace.push({{
              x: traceT,
              y: yYrA,
              mode: 'lines',
              name: 'YrA',
              line: {{ color: 'purple', width: 1 }},
              visible: 'legendonly'
            }});
          }}
          
          // Add C trace (visible by default)
          dataTrace.push({{
            x: traceT,
            y: yRaw,
            mode: 'lines',
            name: 'C',
            line: {{ color: 'blue', width: 1 }},
            visible: true
          }});
          
          // Add filtered C (hidden by default)
          dataTrace.push({{
            x: traceT,
            y: yLp,
            mode: 'lines',
            name: 'C (LPF)',
            line: {{ color: 'green', width: 1.5 }},
            visible: 'legendonly'
          }});
          
          // Add S as minimized pulses at bottom (visible by default)
          if (yS) {{
            // Create vertical line segments for each spike
            const sX = [];
            const sY = [];
            for (let i = 0; i < traceT.length; i++) {{
              if (yS[i] > 0) {{
                const t = traceT[i];
                // Vertical line from base to base + pulse height scaled by S value
                const pulseHeight = sPulseHeight * (yS[i] / Math.max(...yS));
                sX.push(t, t, null);
                sY.push(sPulseBase, sPulseBase + pulseHeight, null);
              }}
            }}
            dataTrace.push({{
              x: sX,
              y: sY,
              mode: 'lines',
              name: 'S',
              line: {{ color: 'red', width: 1 }},
              visible: true
            }});
          }}
          
          // Add spikes above threshold (visible by default)
          dataTrace.push({{
            x: stsAbove,
            y: syAbove,
            mode: 'markers',
            name: 'spikes (speed ≥ ' + speedThreshold + ' ' + speedUnits + ')',
            marker: {{ size: 6, color: 'red' }},
            visible: true
          }});
          
          // Add spikes below threshold (hidden by default)
          dataTrace.push({{
            x: stsBelow,
            y: syBelow,
            mode: 'markers',
            name: 'spikes (speed < ' + speedThreshold + ' ' + speedUnits + ')',
            marker: {{ size: 6, color: 'orange' }},
            visible: 'legendonly'
          }});
          
          const layoutTrace = {{
            title: 'unit ' + uid + ' trace',
            xaxis: {{ title: 'Time (s)' }},
            yaxis: {{ title: 'Fluorescence / spikes' }},
            margin: {{ l: 60, r: 20, t: 40, b: 50 }},
            showlegend: true,
          }};
          Plotly.newPlot('plot_trace', dataTrace, layoutTrace, {{responsive: true}});
        }} else {{
          document.getElementById('plot_trace').innerHTML = '<em>No trace data provided</em>';
        }}
        unitSelect.value = String(idx);
        statusEl.textContent = 'Unit ' + uid + ' (' + (idx + 1) + '/' + unitIds.length + ')';
      }}

      document.getElementById('prev-btn').addEventListener('click', () => {{
        idx = (idx - 1 + unitIds.length) % unitIds.length;
        render();
      }});
      document.getElementById('next-btn').addEventListener('click', () => {{
        idx = (idx + 1) % unitIds.length;
        render();
      }});
      unitSelect.addEventListener('change', () => {{
        idx = parseInt(unitSelect.value, 10);
        render();
      }});

      // initial render
      render();
    </script>
  </body>
</html>

